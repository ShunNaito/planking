<html>
<head>
	<title>現在地の表示</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript" src="./getcsv.js"></script>
	<script type="text/javascript">
	var message;
    var cityCircle;
    var result = loadcsv2('./original_planking.csv'); //CSVのデータから緯度を取得する

    // 観光名所の位置情報と人気度
    var citymap = new Array();

    for(var i=0; i<=result.length-1; i++){
        citymap[i] = {
            center: new google.maps.LatLng(result[i].lat, result[i].lng),//緯度,経度
            population: result[i].pop
        };
    }


    // citymap['USJ'] = {
    //   center: new google.maps.LatLng(result[0].lat, result[0].lng),//緯度,経度
    //   population: result[0].pop
    // };
    // citymap['海遊館'] = {
    //   center: new google.maps.LatLng(result[1].lat, result[1].lng),
    //   population: result[1].pop
    // };
    // citymap['大阪市立科学館'] = {
    //   center: new google.maps.LatLng(result[2].lat, result[2].lng),
    //   population: result[2].pop
    // };
    // citymap['交通科学博物館'] = {
    //   center: new google.maps.LatLng(result[3].lat, result[3].lng),
    //   population: result[3].pop
    //};

    // 位置情報取得
    function start_func(){
    	get_location();
    }

    // ( 1 )位置情報を取得します。
    function get_location(){
    	document.getElementById("area_name").innerHTML
    	= '位置情報取得します';
    	if (navigator.geolocation) {
        // 現在の位置情報取得を実施 正常に位置情報が取得できると、
        // successCallbackがコールバックされます。
        navigator.geolocation.getCurrentPosition
        (successCallback,errorCallback);
        } else {
        	message = "本ブラウザではGeolocationが使えません";
        	document.getElementById("area_name").innerHTML
        	= message;
        }
    }
    // ( 2 )位置情報が正常に取得されたら
    function successCallback(pos) {
    	var Potition_latitude = pos.coords.latitude; //緯度
    	var Potition_longitude = pos.coords.longitude;　//軽度

        // 位置情報が取得出来たらGoogle Mapを表示する
        initialize(Potition_latitude,Potition_longitude);
    }

    function errorCallback(error) {
    	message = "位置情報が許可されていません";
    	document.getElementById("area_name").innerHTML = message;
    }

    // ( 3 )Google Map API を使い、地図を読み込み
    function initialize(x,y) {
    	document.getElementById("area_name").innerHTML
    	= 'google map情報を取得中';

        // Geolocationで取得した座標を代入
        var myLatlng = new google.maps.LatLng(x,y);

        var mapOptions = {
        	zoom: 17,
        	center: myLatlng,
        	mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        // MapTypeId に、地図タイプを指定
        // HYBRID 衛星画像と主要な通りが表示されます
        // ROADMAP 通常の地図画像が表示されます
        // SATELLITE 衛生画像が表示されます。
        // TERRAIN 地形や植生などのマッピングをします。

        var map = new google.maps.Map
        (document.getElementById("map_canvas"), mapOptions);

        // Construct the circle for each value in citymap.
        // Note: We scale the area of the circle based on the population.
        for (var city in citymap) {
            var populationOptions = {
              strokeColor: '#FF0000',
              strokeOpacity: 0.8, //透明度
              strokeWeight: 2,
              fillColor: '#FF0000',
              fillOpacity: 0.35,
              map: map,
              center: citymap[city].center,
              radius: Math.sqrt(citymap[city].population) * 50
            };
            // Add the circle for this city to the map.
            cityCircle = new google.maps.Circle(populationOptions);
        }

        //現在地にマーカーを置く
        var marker = new google.maps.Marker({
        	position: myLatlng,
        	map: map,
        	title:"Your position"
        });
        get_area_name(myLatlng);
    }

    function get_area_name(latLng_now){
        // 座標から住所名を取得
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({latLng: latLng_now}, function(results, status){
        	if(status == google.maps.GeocoderStatus.OK){
        		document.getElementById("area_name").innerHTML
        		= results[0].formatted_address+'付近にいます';
        	} else {
        // エラーの場合
            }
        });
    }


    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body onload="start_func()">
	<div id="map_canvas" style="width:100%; height:90%">
		位置情報を取得しています....
	</div>
	<div id="area_name"></div>
    <div align="center">
        <a href="camera.html"><img src="img/camera.png" width="13" height="13" alt="カメラ"></a>
    </div>
</body>
</html>